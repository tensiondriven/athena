# PTZ Camera Control REST API - Systemd Service Configuration
# Copy this file to /etc/systemd/system/ptz-api.service

[Unit]
Description=PTZ Camera Control REST API
Documentation=file:///opt/ptz-rest-api/README.md
After=network.target
Wants=network.target

[Service]
Type=notify
User=www-data
Group=www-data
WorkingDirectory=/opt/ptz-rest-api
Environment=PATH=/opt/ptz-rest-api/venv/bin
Environment=FLASK_ENV=production
Environment=SECRET_KEY=your-production-secret-key-here
Environment=LOG_LEVEL=INFO
Environment=LOG_FILE=/var/log/ptz-api/ptz-api.log

# Main service command
ExecStart=/opt/ptz-rest-api/venv/bin/gunicorn \
    --workers 4 \
    --bind 0.0.0.0:5000 \
    --timeout 30 \
    --keepalive 5 \
    --max-requests 1000 \
    --max-requests-jitter 100 \
    --access-logfile /var/log/ptz-api/access.log \
    --error-logfile /var/log/ptz-api/error.log \
    --log-level info \
    'src.ptz_rest_api.main:create_app()'

# Reload configuration
ExecReload=/bin/kill -s HUP $MAINPID

# Restart policy
Restart=always
RestartSec=5
StartLimitInterval=60
StartLimitBurst=3

# Resource limits
LimitNOFILE=65536
MemoryLimit=512M

# Security settings
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/ptz-rest-api/screenshots /var/log/ptz-api
CapabilityBoundingSet=CAP_NET_BIND_SERVICE

# User and group for camera access
SupplementaryGroups=video audio

[Install]
WantedBy=multi-user.target

# Installation instructions:
# 1. Copy this file to /etc/systemd/system/ptz-api.service
# 2. Create log directory: sudo mkdir -p /var/log/ptz-api
# 3. Set permissions: sudo chown www-data:www-data /var/log/ptz-api
# 4. Add www-data to video group: sudo usermod -a -G video www-data
# 5. Reload systemd: sudo systemctl daemon-reload
# 6. Enable service: sudo systemctl enable ptz-api
# 7. Start service: sudo systemctl start ptz-api
# 8. Check status: sudo systemctl status ptz-api