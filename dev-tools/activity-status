#!/bin/bash

# Activity Status - Real-time file activity monitor for Athena development
# Shows recent file reads/writes with timing and operation type

PROJECT_ROOT="/Users/j/Code/athena"
REFRESH_RATE=0.33
MAX_FILES=15

format_time_ago() {
    local seconds=$1
    if [ $seconds -lt 60 ]; then
        echo "${seconds}s"
    elif [ $seconds -lt 3600 ]; then
        echo "$((seconds/60))m"
    else
        echo "$((seconds/3600))h"
    fi
}

get_file_activity() {
    # Much faster: only check files modified in last 10 minutes
    local cutoff=$(($(date +%s) - 600))
    local now=$(date +%s)
    
    # Use find with -newer for speed, limit to key directories
    find "$PROJECT_ROOT"/{docs,system,dev-tools} -type f \
        -newermt "@$cutoff" 2>/dev/null | \
    head -$MAX_FILES | \
    while read filepath; do
        local timestamp=$(stat -f '%m' "$filepath" 2>/dev/null || echo 0)
        local ago=$((now - timestamp))
        local basename=$(basename "$filepath")
        local relpath=$(echo "$filepath" | sed "s|$PROJECT_ROOT/||")
        local time_str=$(format_time_ago $ago)
        
        # Determine operation type based on file extension and recency
        local op_type="ğŸ“"  # default to write
        if [[ "$basename" == *".md" ]] && [ $ago -lt 5 ]; then
            op_type="âœï¸ "  # recent markdown write
        elif [[ "$basename" == *".py" ]] && [ $ago -lt 5 ]; then
            op_type="ğŸ"  # recent python write
        elif [[ "$basename" == *".json" ]] && [ $ago -lt 5 ]; then
            op_type="ğŸ“‹"  # recent config write
        elif [ $ago -gt 30 ]; then
            op_type="ğŸ‘ï¸ "  # older, likely read
        fi
        
        echo "$timestamp $op_type $time_str $relpath"
    done | sort -nr | head -$MAX_FILES | cut -d' ' -f2-
}

show_header() {
    echo "ğŸ”„ Athena Development Activity Monitor"
    echo "ğŸ“ Project: $PROJECT_ROOT"
    echo "â±ï¸  Refresh: ${REFRESH_RATE}s"
    echo "----------------------------------------"
    printf "%-3s %-6s %s\n" "OP" "AGO" "FILE"
    echo "----------------------------------------"
}

check_self_update() {
    local script_path="$0"
    local last_modified=$(stat -f '%m' "$script_path" 2>/dev/null || echo 0)
    
    if [ -z "$SCRIPT_LAST_MODIFIED" ]; then
        export SCRIPT_LAST_MODIFIED=$last_modified
    elif [ "$last_modified" -gt "$SCRIPT_LAST_MODIFIED" ]; then
        echo "ğŸ”„ Script updated, restarting..."
        exec "$script_path" "$@"
    fi
}

main() {
    if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
        echo "Usage: $0 [--once]"
        echo ""
        echo "Options:"
        echo "  --once    Show activity once and exit"
        echo "  --help    Show this help"
        echo ""
        echo "Icons:"
        echo "  ğŸ“ Write operation (recent)"
        echo "  ğŸ‘ï¸  Read operation (older)"
        echo "  âœï¸  Markdown edit"
        echo "  ğŸ Python edit"
        echo "  ğŸ“‹ Config edit"
        echo ""
        echo "Features:"
        echo "  ğŸ”„ Auto-restarts when script is modified"
        exit 0
    fi
    
    if [ "$1" = "--once" ]; then
        show_header
        get_file_activity
        exit 0
    fi
    
    # Continuous monitoring with self-update detection
    while true; do
        check_self_update "$@"
        clear
        show_header
        get_file_activity
        sleep $REFRESH_RATE
    done
}

main "$@"